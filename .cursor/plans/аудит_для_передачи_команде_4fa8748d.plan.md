---
name: Аудит для передачи команде
overview: "План повторного архитектурного аудита findmystuff для передачи проекта другой команде: устранение дублирования в API и entity-конфигах, единообразие нейминга и размещения типов/контекстов, упрощение длинных обработчиков и сложного потока, документация онбординга и конвенций."
todos: []
isProject: false
---

# Аудит проекта для передачи другой команде

Цель: новая команда должна быстро разобраться в проекте и начать доработки. Помимо документации и тестов, код должен быть предсказуемо организован.

### Принятые решения

- **2.1 entity-config:** не переименовывать файлы; в разделе «Архитектура и код» в README явно описать: типы списков — `lib/app/types/entity-config.ts`, конфиги сущностей — `lib/entities/<entity>/entity-config.ts`.
- **1.5 move-метки:** оставить как есть; в конвенциях зафиксировать шаблон entity-config для новых сущностей (без фабрики и без констант *_MOVE_LABELS).
- **3.1 длинные GET [id]:** выносить загрузку в `lib/<domain>/`: например `lib/rooms/load-room-detail.ts`, `lib/places/load-place-detail.ts`, `lib/containers/load-container-detail.ts`.
- **6 документация:** расширить раздел «Архитектура и код» в README (без отдельного docs/ARCHITECTURE.md). Конвенции по контрибьютингу при необходимости — в том же README.
- **4.2 HTTP-коды:** завести константы `HTTP_STATUS` и использовать везде — в хелперах и во всех API-маршрутах.
- **2.2 контексты/типы:** не переносить `contexts/` и `types/` под `lib/`; только описать в README, где что лежит.
- **2.3 services vs helpers:** не переименовывать папки; в конвенциях описать разницу (services — слой API↔UI, helpers — утилиты).

---

## 1. Дублирование кода

### 1.1 Auth и tenant в API

**Сейчас:** хелперы `requireAuthAndTenant` и `parseId` есть в [lib/shared/api/require-auth.ts](lib/shared/api/require-auth.ts) и [lib/shared/api/parse-id.ts](lib/shared/api/parse-id.ts), но используются только в `app/api/items/[id]/route.ts` и `app/api/entities/[table]/[id]/route.ts`. Остальные маршруты (buildings, rooms, containers, places, furniture, items/route, transitions, entity-types, users, search, tenants, barcode-lookup, duplicate и др.) вручную вызывают `getServerUser()` + `getActiveTenantId()` и возвращают одни и те же 401/400.

**Действие:** во всех API-обработчиках, где нужны user и tenant, заменить ручной блок на вызов `requireAuthAndTenant(request)`; при необходимости оставить отдельно `requireAuth` или `requireTenant` там, где нужен только один из них.

### 1.2 Парсинг id в [id]-маршрутах

**Сейчас:** `parseId()` используют только items/[id] и entities/[table]/[id]. В [app/api/buildings/[id]/route.ts](app/api/buildings/[id]/route.ts), [app/api/rooms/[id]/route.ts](app/api/rooms/[id]/route.ts), [app/api/containers/[id]/route.ts](app/api/containers/[id]/route.ts), [app/api/places/[id]/route.ts](app/api/places/[id]/route.ts), [app/api/furniture/[id]/route.ts](app/api/furniture/[id]/route.ts) — ручной `parseInt(params.id, 10)` и проверка с разными подписями («Неверный ID здания», «Неверный ID помещения» и т.д.).

**Действие:** везде перейти на `parseId(resolvedParams.id, { entityLabel: "здания" | "помещения" | "контейнера" | "места" | "мебели" })` и убрать дублирующий код.

### 1.3 Обработка ошибок в catch

**Сейчас:** в большинстве route-файлов один и тот же паттерн: `catch (error) { console.error("...", error); return NextResponse.json({ error: error instanceof Error ? error.message : "..." }, { status: 500 }); }` с разными строками для `console.error` и текста ошибки.

**Действие:** ввести в `lib/shared/api/` хелпер вида `apiErrorResponse(error, { context?: string; defaultMessage?: string })`, возвращающий `NextResponse` с 500 и единообразным телом `{ error: string }`, и вызывать его из всех catch-блоков API.

### 1.4 parseOptionalInt

**Сейчас:** одна и та же функция объявлена в [app/api/places/route.ts](app/api/places/route.ts) и [app/api/furniture/route.ts](app/api/furniture/route.ts). В items/route и containers/route похожая логика реализована inline.

**Действие:** вынести общую функцию в `lib/shared/api/parse-optional-int.ts` (или в существующий модуль парсинга) и использовать во всех перечисленных маршрутах.

### 1.5 Entity configs

**Сейчас:** в [lib/entities/](lib/entities/) шесть конфигов (items, places, rooms, buildings, containers, furniture) с очень похожей структурой: `*Filters`, `DEFAULT_*_FILTERS`, `fetch`* + `createFetchListResult`, одинаковый каркас `labels` (singular, plural, results, moveTitle/moveSuccess/moveError, deleteConfirm и т.д.), `addForm`, `columns`, `actions.whenActive`/`whenDeleted`. Отличия в основном в наборе фильтров и колонок.

**Действие:** зафиксировать в конвенциях (README), что новый entity-config должен следовать текущему шаблону (labels, fetch + createFetchListResult, columns, filters, actions). Move-метки и структуру не унифицировать принудительно; фабрику/базовый конфиг не вводить.

---

## 2. Нейминг и размещение файлов

### 2.1 Двусмысленное имя «entity-config»

**Сейчас:**  

- [lib/app/types/entity-config.ts](lib/app/types/entity-config.ts) — только типы (EntityDisplay, Filters, EntityLabels, ListColumnConfig, FetchListResult и т.д.).  
- [lib/entities//entity-config.ts](lib/entities/items/entity-config.ts) — конфиги сущностей (экспорт `itemsEntityConfig`, `placesEntityConfig` и т.д.).

Один и тот же термин «entity-config» для типов и для конфигов затрудняет поиск и онбординг.

**Действие:** не переименовывать. В разделе «Архитектура и код» в README явно описать: «типы списков сущностей — `lib/app/types/entity-config.ts`, конфиги по сущностям — `lib/entities/<entity>/entity-config.ts`».

### 2.2 Контексты и типы в разных корнях

**Сейчас:**  

- Контексты: корень [contexts/tenant-context.tsx](contexts/tenant-context.tsx), [lib/users/context.tsx](lib/users/context.tsx), [lib/settings/context.tsx](lib/settings/context.tsx), [lib/app/contexts/](lib/app/contexts/) (add-item, current-page, quick-move).  
- Типы: корень [types/entity.ts](types/entity.ts), плюс [lib/app/types/](lib/app/types/) (entity-config, entity-action).

**Действие:** в README (раздел 6) зафиксировать конвенцию: «глобальные типы сущностей и API — `types/entity.ts`, типы списков и действий — `lib/app/types/`; контексты приложения — `lib/app/contexts/`, контекст тенанта — `contexts/`, доменные контексты (users, settings) — в соответствующих `lib/<domain>/`». Перенос `contexts/` и `types/` под `lib/` не делать.

### 2.3 services vs helpers

**Сейчас:** в [lib/entities/](lib/entities/) есть и [lib/entities/services/item-detail.ts](lib/entities/services/item-detail.ts), и [lib/entities/helpers/](lib/entities/helpers/) (display-name, fetch-list, quick-move, sort, qr-code, label-print). В других доменах (buildings, rooms, places и т.д.) папки `services/` нет.

**Действие:** в конвенциях (README) описать: «services — слой между API и UI (загрузка и нормализация данных страницы); helpers — чистые утилиты и форматирование». Переименование папок не делать.

### 2.4 Два корня тестов

**Сейчас:** **[tests**/](__tests__/) — Jest (юнит), [tests/](tests/) — Playwright (e2e).

**Действие:** в README в разделе «Архитектура и код» или в отдельном разделе явно указать: «Юнит-тесты: `__tests__/`, зеркалят структуру `lib/`. E2E: `tests/`, Playwright.»

---

## 3. Сложная логика и длинные функции

### 3.1 Длинные GET-обработчики [id]

**Сейчас:**  

- [app/api/rooms/[id]/route.ts](app/api/rooms/[id]/route.ts) — GET ~198 строк, несколько волн запросов и маппингов.  
- [app/api/places/[id]/route.ts](app/api/places/[id]/route.ts) — GET ~265 строк.  
- [app/api/containers/[id]/route.ts](app/api/containers/[id]/route.ts) — GET ~285 строк.

Трудно проследить поток данных и ветки без комментариев или разбиения.

**Действие:** вынести загрузку и сборку данных в отдельные модули в `lib/<domain>/`: `lib/rooms/load-room-detail.ts`, `lib/places/load-place-detail.ts`, `lib/containers/load-container-detail.ts`. В route оставить только: auth, parseId, вызов загрузки, обработку ошибок и ответ. В README (раздел архитектуры) добавить краткое описание шагов (загрузка сущности → transitions → дочерние сущности → маппинг) или схему.

### 3.2 fetchPlacesFallback и GET places

**Сейчас:** [app/api/places/route.ts](app/api/places/route.ts) — в GET вложенная обработка ошибки RPC (fallback при `CODE_COLUMN_MISSING_ERROR`) и функция `fetchPlacesFallback` ~130 строк с несколькими запросами и картами.

**Действие:** разбить `fetchPlacesFallback` на подфункции (построение запроса, загрузка, сбор карт roomNameById / counts); в GET оставить короткую цепочку: RPC → при ошибке fallback → маппинг → ответ.

### 3.3 useListPage

**Сейчас:** [lib/app/hooks/use-list-page.tsx](lib/app/hooks/use-list-page.tsx) — хук ~268 строк, много `useState`/`useCallback`/`useEffect`, ветвления по pagination/addForm, большой эффект загрузки с отключённым eslint по deps и комментарием про «бесконечный цикл».

**Действие:**  

- Вынести в отдельные файлы уже существующие внутренние хуки `useRequestKey` и `useDebouncedSearch` и при необходимости упростить их зависимости.  
- Добавить в код или в доку краткое описание потока: «ключ запроса от filters/sort/page → один эффект загрузки → обновление data/totalCount/error».  
- По возможности разбить хук на подхуки (например, «URL state + filters» и «загрузка + ключ запроса») без ломания существующих страниц.

### 3.4 fetchEntityName в quick-move-dialog

**Сейчас:** [components/quick-move/quick-move-dialog.tsx](components/quick-move/quick-move-dialog.tsx) — функция `fetchEntityName` с пятью подряд ветками `if (entityType === "item")` … `"furniture"` и дублирующимся вызовом API и форматированием.

**Действие:** заменить на один маппинг «entityType → функция загрузки» (или один общий метод API по типу сущности) и один вызов с подстановкой имени; убрать копипаст веток.

### 3.5 entity-filters-panel

**Сейчас:** [components/filters/entity-filters-panel.tsx](components/filters/entity-filters-panel.tsx) — длинная цепочка `if (field.type === "yesNoAll")` … `"locationType"` … `"room"` и т.д.

**Действие:** заменить на `switch (field.type)` или объект/map «type → компонент поля», чтобы добавление нового типа фильтра было одним изменением в одном месте.

---

## 4. Имена переменных и магические значения

### 4.1 Однобуквенные и неочевидные имена

**Сейчас:** в API-маршрутах в колбэках часто используются `(t)`, `(r)`, `(f)`, `(p)`, `(c)` для transition/row/furniture/place/container; в [lib/entities/helpers/quick-move.ts](lib/entities/helpers/quick-move.ts) — `a`, `b` для двух сканов (EntityQrPayload).

**Действие:** в местах, где контекст неочевиден (особенно в длинных файлах), заменить на осмысленные имена: `transition`, `row`, `place`, `container`, `firstScan`, `secondScan`. В коротких колбэках типа `.map((e) => e.id)` оставить как есть.

### 4.2 Магические числа и строки

**Сейчас:**  

- Коды ответа 401, 400, 404, 500 повторяются по всем route без общих констант.  
- В [app/api/places/route.ts](app/api/places/route.ts) — `page_limit: 2000`, `limit(2000)`.  
- В [lib/app/hooks/use-list-page.tsx](lib/app/hooks/use-list-page.tsx) — дефолт `pageSize = 20`.  
- В формах — `setTimeout(..., 100)` / `200`.  
- В [lib/shared/api/find-entity-image-server.ts](lib/shared/api/find-entity-image-server.ts) — `10 * 1024 * 1024` (10MB).

**Действие:** ввести в `lib/shared/api/` (или общий constants) константы `HTTP_STATUS` (UNAUTHORIZED, BAD_REQUEST, NOT_FOUND, INTERNAL_SERVER_ERROR и т.д.) и использовать их **везде** — в хелперах и во всех API-маршрутах. Вынести лимиты (2000, 20, 10MB) и таймауты (100, 200 ms) в именованные константы с комментарием назначения.

---

## 5. Лишний функционал и овер-сложность

### 5.1 Цепочка списка сущностей

**Сейчас:** entity-config → resolve-actions → useListPage → ListPageContent → EntityList → EntityRow плюс конфиги колонок и фильтров. Цепочка длинная, но уже используется везде; рефакторинг «в лоб» рискован.

**Действие:** не менять архитектуру списка в первую очередь. В документе для команды описать поток: «конфиг сущности (columns, filters, fetch, actions) → useListPage (состояние, URL, загрузка) → EntityList/EntityRow (рендер)» и указать файлы. При следующих крупных фичах рассматривать упрощение (например, объединение resolve-actions с конфигом).

### 5.2 URL-состояние списка

**Сейчас:** несколько слоёв — `listPageUrlParsers`, `createListPageParsers`, `urlStateToFilters`, `filtersToUrlState` в [lib/app/hooks/list-page-url-state.ts](lib/app/hooks/list-page-url-state.ts).

**Действие:** оставить как есть; при следующем касании этого модуля рассмотреть более плоский API (один объект парсеров + одна функция «url → state» и «state → url») и добавить краткий комментарий в начало файла о назначении модуля.

---

## 6. Документация для новой команды

**Сейчас:** README описывает быстрый старт, env, Supabase, деплой и краткий блок «Архитектура и код» (структура данных, ESLint). Нет отдельного ARCHITECTURE.md, CONTRIBUTING.md, нет явного описания «где что лежит» и типичных потоков (запрос списка, создание сущности, перемещение).

**Действие:** расширить раздел «Архитектура и код» в README (отдельный docs/ARCHITECTURE.md не создавать). Включить:  

- Назначение основных папок (`app/`, `lib/`, `components/`, `contexts/`, `types/`).  
- Где типы сущностей и списков (`types/entity.ts`, `lib/app/types/`), где конфиги сущностей и различие entity-config (типы) vs конфиги в `lib/entities/<entity>/entity-config.ts`.  
- Типичный API-маршрут (auth → tenant → парсинг → Supabase/API → ответ) и общие хелперы (`require-auth`, `parse-id`, `apiErrorResponse`, `validate-item-money`, `normalize-entity-type-relation`).  
- Список сущностей (useListPage + EntityList + entity-config), страница детали (загрузка по id, формы, переходы).  
- Схема данных (rooms → places → containers → items, transitions) и мультитенантность (tenant_id, cookie, getActiveTenantId).  
- Конвенции: куда класть новые API-маршруты, как добавлять сущность (entity-config, api.ts, миграции), тесты (Jest в `__tests__/`, e2e в `tests/`). При необходимости оформить подраздел «Контрибьютинг» в том же README.

---

## 7. Сводка приоритетов


| Приоритет   | Что сделать                                                                                                                                                                                                                                                                |
| ----------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Высокий** | Единообразно использовать requireAuthAndTenant и parseId во всех подходящих API-маршрутах; ввести apiErrorResponse и parseOptionalInt в shared; константы HTTP_STATUS везде (хелперы и маршруты); расширить раздел «Архитектура и код» в README (архитектура + конвенции). |
| **Средний** | Разбить длинные GET [id]: вынести loadRoomDetail, loadPlaceDetail, loadContainerDetail в lib/rooms, lib/places, lib/containers; разбить fetchPlacesFallback; улучшить имена переменных (API, quick-move); вынести магические числа и лимиты в константы.                   |
| **Низкий**  | Описать в README различие entity-config (типы vs конфиги); упростить fetchEntityName и entity-filters-panel через map/switch; вынести useRequestKey/useDebouncedSearch и описать поток useListPage.                                                                        |


После выполнения высокого приоритета новая команда получит единый стиль API, меньше дублирования и явный раздел в README для онбординга; средний и низкий приоритет можно закрывать по мере касания соответствующих файлов.